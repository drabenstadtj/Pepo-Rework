extends layout

block content
  .container
    h1 Admin Dashboard
    p Welcome, #{user.username}, to the admin panel!

    // Form for updating volatility
    form#volatilityForm(method="POST", action="")
      div
        label(for="stock_selector") Select Stock:
        select#stock_selector(name="symbol")
          option(value="") Select a stock
          each stock in stocks
            option(value=stock.symbol)= stock.symbol

      // Volatility Factor Update Form
      div
        label(for="volatility_factor_slider") Volatility:
        input#volatility_factor_slider(type="range" min=".01" max="2" step="0.01" value="0.5" name="volatility_slider")
        
      // Textbox for displaying the selected volatility
      input#volatility_factor_input(type="text" name="volatility_factor" readonly value="0.5")

      div
        button(type="submit") Update Volatility

    h2 Add News Article

    // Form for adding news articles
    form#newsForm(method="POST", action="/admin/add-news")
      div
        label(for="title") Title:
        input#title(type="text" name="title" placeholder="Enter news title" required)

      div
        label(for="content") Content:
        textarea#content(name="content" placeholder="Enter news content" required)

      div
        label(for="author") Author:
        input#author(type="text" name="author" placeholder="Enter author name" required)

      div
        label(for="timestamp") Timestamp:
        input#timestamp(type="datetime-local" name="timestamp" value="2024-09-13T00:19" required)

      div
        label(for="isFeatured") Is Featured:
        input#isFeatured(type="checkbox" name="isFeatured")

      div
        label(for="thumbnail") Thumbnail URL:
        input#thumbnail(type="text" name="thumbnail" placeholder="Enter thumbnail URL (optional)" pattern="^(https?:\/\/.*)?$")
        
      div
        button(type="submit") Add News Article


    // Display Success or Error Message if they exist
    if success
      div.alert.alert-success= success  
    if error
      div.alert.alert-danger= error 

    if success || error
      script.
        if (history.replaceState) {
          const url = new URL(window.location);
          url.searchParams.delete('success');
          url.searchParams.delete('error');
          history.replaceState(null, '', url);
        }

    // JavaScript to update form action and populate volatility values
    script.
      const stocks = !{JSON.stringify(stocks)};  // Get stocks data from server
      const volatilityForm = document.getElementById('volatilityForm');
      const stockSelector = document.getElementById('stock_selector');
      const slider = document.getElementById('volatility_factor_slider');
      const input = document.getElementById('volatility_factor_input');
      
      // Update form action and populate slider/input values
      stockSelector.addEventListener('change', function() {
        const selectedSymbol = this.value;
        if (selectedSymbol) {
          // Find the selected stock in the stocks array
          const selectedStock = stocks.find(stock => stock.symbol === selectedSymbol);
          if (selectedStock) {
            // Update the slider and input with the stock's volatility factor
            slider.value = selectedStock.volatility_factor;
            input.value = selectedStock.volatility_factor;

            // Set the form action to the correct update URL
            volatilityForm.action = `/admin/stocks/${selectedSymbol}/update_volatility`;
          }
        } else {
          // Reset the form action and input fields if no stock is selected
          volatilityForm.action = '';
          slider.value = 0.5;
          input.value = 0.5;
        }
      });

      // Sync the slider with the text input
      slider.addEventListener('input', function() {
        input.value = slider.value;
      });
